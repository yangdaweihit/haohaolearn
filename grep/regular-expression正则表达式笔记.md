[TOC]

**正则表达式 :regular expression**(Regex)，用以匹配和处理文本的字符串，查找和替
换特定信息的工具。

根据匹配规则，符合条件的内容会被匹配到并返回（[前后查找](#前后查找)规则可定义符
合某匹配条件，但不返回该匹配结果的模式，具体查看该小节介绍）。

# 匹配单个字符

- 字符本身
  
  `a`匹配到`a` ，`\?`匹配到`?` `[abc]`匹配 a 或 b 或 c

- **任意一个字符** `.` （除了点号本身）
  
  要匹配`.`本身，需使用转义符：`\.`

# 匹配一组字符

- 多个字符中的某一个
  
  要匹配的字符集合写入`[ ]`中。 如：匹配 aac bbc ccc 中的 ac 和 bc：`[ab]c` 匹配
  到了 aac bbc

- 字符集合区间
  
  一个字符到另一个字符之间使用 `-` 。如：：`1-9` `a-z` `A-Z`等等。

- 不匹配一组字符
  
  在字符集合最前面写上`^`，该字符集合中所有字符都不被匹配。如：`[^def]` 表示不匹
  配 d、e 和 f

# 元字符

* 特殊字符：在正则表达式中具有特殊意义的字符，如`\` `.` `[ ]` `?` `*` `+`等（它
  们的特殊意义介绍将分散在后文各个章节中）。
  
  要去掉特殊字符的特殊含义，**只使其代表该字符本身**，需要使用转义符`\` 。在字符
  前面加上`\`即可去掉字符的特殊意义，如 `\?` 匹配到了`\?` ，`\\`匹配到`\`（反斜
  杠）。
  
  以下特殊字符需要转义后才能只表示其本身：
  
  * `\` 特殊意义：**转义符** 其加上某些字符会成为元字符（见下文）
  * `^` `$` 特殊意义：[字符串边界](#字符串边界) 和 字符集和取非（位于`[]`中时
    `）
  * `.` 特殊意义：[匹配任意一个字符](#匹配单个字符)
  * `*` `+` `?` 特殊意义：[重复匹配元字符](#重复匹配)
  * `|` 特殊意义：[逻辑或](#逻辑与或非)
  * `{` 特殊意义：用于指定次数的[重复匹配](#重复匹配)
  * `[` 特殊意义：用于[字符集合](匹配一组字符)
  * `(` `)` 特殊意义：用于[子表达式](#子表达式)

* 空白元字符：匹配空白字符
  
  | 元字符  | 匹配说明                  |
  | ---- | --------------------- |
  | [\b] | 回退符（backspace 键盘）     |
  | \f   | 换页符（form feed ）       |
  | \n   | 换行符（new line ）        |
  | \r   | 回车符（carriage return ） |
  | \t   | 制表符（tab ）             |
  | \v   | 垂直制表符（vertical tab ）  |
  
  `\r\n`是一个回车加换行组合，在 windows 中，它作为文本行的结束标签（结束上段文
  本并添加一个空白行）。

* 特定字符类别：匹配一类字符
  
  | 元字符 | 匹配说明                     | 等价表达式         |
  | --- | ------------------------ | ------------- |
  | \d  | 数字（digit ）               | [0-9]         |
  | \D  | 非数字                      | [^0-9]        |
  | \w  | 数字、字母或下划线（word ）         | [a-zA-Z0-9_]  |
  | \W  | 非字母、数字或下划线               | [^a-za-z0-9_] |
  | \s  | 空白字符（white space ）       | [\f\n\r\t\v]  |
  | \S  | 非空白字符                    | [^\f\n\r\t\v] |
  | \x  | 十六进制（hexadecimal digit ） |               |
  | \0  | 八进制（Octal digit ）        |               |
  
  汉字匹配：[u4e00-u9fa5]，在有些支持 unicode 的正则，`\w`会包括汉字 (? 待考证 )
  
  > 某些情况下，\w 也会匹配本地字符集，比如中文系统的中文

# 重复匹配

* 不确定重复匹配次数
  
  * `?` **0 或 1**
    
    字符（或字符集合 / 字表达式）的零次或一次重复
  
  * `+` **至少 1**
    
    字符（或字符集合 / 字表达式）的一次或多次重复
  
  * `*` **任意**
    
    字符（或字符集合 / 字表达式）的零次或多次重复
  
  注意：重复匹配字符**在正则中不能单独使用**，需要配合其他字符（字符集合 / 字表
  达式）使用，以表示重复前面的内容 n 次。在通配符中这些字符则可以单独使用，
  如`*`就表示任意个数的字符。

* 指定重复匹配次数
  
  * `{n}` 精确的重复次数：匹配 n 次（n 是一个自然数，下面的 m 同理）
  * `{m,n}` 区间内的重复次数：至少匹配 m 次，至多匹配 n 次。
  * `{n,}`至少重复次数：至少重复 n 次，最多匹配次数无上限。
- 防止过度匹配（贪婪匹配和懒惰匹配）
  
  使用重复匹配时，默认会尽可能多地匹配，这种情况被称作 “ 贪婪 ” 模式；
  
  如果在重复匹配规则后面加上`?` ，就成了 “ 懒惰 ” 模式，与 “ 贪婪 ” 模式相反，它
  会尽可能少地匹配）。示例：`*?` `+?` `{number,}?`

# 边界匹配

* 字符串边界
  * 字符开始：`^`
  * 字符串结尾：`$`

许多正则表达式支持使用一些特殊元字符去改变另外一些元字符的行为，例如：

分行匹配模式（multiline mode ）的**(? m)**记号，使得正则表达式引擎把行分隔符当作
一个字符串分隔符来对待。如：`(? m)^\s*//.*$` 匹配每一行的 // 及其后面（仅本行）
的字符

* 单词边界
  
  * `\b`：匹配某单词的边界（限定单词的开始和结尾，划定 \w 相匹配的字符的边界）
    
    如：匹配 The **cat** scattered its food 中的 cat（猫，排除掉 scattered）这个
    词：`\bcat \b`（注意：cat 后有空格）
- `\B`： 不匹配某单词的边界（非单词边界）
  
  如：`\B - \B` 将匹配一个前后都不是单词的连字符。（因为空格和连字符都不是数字、
  字母或者下划线，即不属于`\w`）

# 逻辑与或非

* “ 与 ” 是正则表达式中最普通的逻辑关系。一般来说，如果正则表达式中的元素没有任
  何量词（quantifier ，比如 \*、? 、 +）修饰，就是 “ 与 ” 关系。

* “ 或 ”
  
  * 重复匹配的元字符`?` `+` `*` 重复匹配次数是或关系
    
    如`a?`表示匹配到 1 个 a 或 0 个 a（没有 a）
  
  * `[]` 单个字符或关系 括号内的每个字符彼此都是或关系
    
    如`[abc]`表示匹配 a 或 b 或 c
  
  * `|` 单个或多个字符（需要使用[子表达式](#子表达式)）或关系
    
    如`a|b|c`表示匹配 a 或 b 或 c
    
    如`(png|jpg|gif)` 表示匹配 png 或 jpg 或 gif

* " 非 "
  
  * `[^]` 括号中使用`^`
    
    如`[^123]`表示匹配非 123 中任意一个
  
  * [前后匹配](#前后查找)中的取非

# 子表达式

子表达式作用是把正则表达式中某一部分划为一个独立元素进行使用。

子表达式写在圆括号 **`()`** 之中。

子表达式可以进行嵌套。

## 回溯引用

子表达式建立后需要对其使用方有意义。

回溯引用即正则表达式中，后面的部分**引用**在前面已经定义的**子表达式**。

不同语言有不同的写法，如`$n`,`[n]`,`\n`（n 是一个自然数，注意：当 n 为 0，表示整
个表达式）。此处以`\n`为示例（例如bash中使用`\n`表示引用第n个子表达式）。

**命名捕获** ： 由于 n 是对应固定的子表达式位置，如子表达式顺序改动则会发生匹配偏差。命名捕获用以**子表达式的特殊命名**，以示区分。*目前此种实现未得到广泛支持*。

回溯引用中的大小写转换元字符：

| 元字符 | 说明                     |
| --- | ---------------------- |
| \E  | 结束 \L 或 \U 转换          |
| \l  | 把下一个字符转换为小写            |
| \L  | 把 \L 的 \E 之间的字符全部转换为小写 |
| \u  | 把下一个字符转换为大写            |
| \U  | 把 \U 到 \E 之间的字符全部转换为大写 |

## 前后查找

适用场景：子表达式匹配的内容**仅用于确定正确的匹配位置**，而**不作为匹配结果的一部分返回**。

* 因为前后查找子表达式不作为返回结果的一部分——即其返回结果是 0 字节，因此又名零宽度（zero-width ）匹配操作（也有翻译为“零宽度断言”——前后查找翻译为“前后断言”）。
* 将前或向后查中的`=`换成`!`对其**取非** ，即排除该种匹配的情况。
* 向前查找可以指定可变长度（如`.+`、`.{2,}`等），向后查找只能指定固定长度（必须
  指定长度，如`.{2,5}`，不能使用`*`、`+`、`?`等不确定长度）
* 某些语言不一定支持前后查找（或其中某个），例如：JavaScript 不支持向后查找。

| 操作符     | 说明            |
| ------- | ------------- |
| `(?=)`  | 向前查找（正向前查找）   |
| `(?!)`  | 向前查找取非（负向前查找） |
| `(?<=)` | 向后查找（正向后查找）   |
| `(?<!)` | 向后查找取非（负向后查找） |

示例：

- 不同情况的前后匹配：
  
  - 匹配后面是bbb的aaa  `aaa(?=bbb)`   aaabbb中的aaa符合
  - 匹配后面不是bbb的aaa  `aaa(?!bbb)`   aaabbb中的aaa不符合
  - 匹配前面是bbb的aaa  `(?<=bbb)aaa`   bbbaaa中的aaa符合
  - 匹配前面不是bbb的aaa  `(?<!bbb)aaa`  bbbaaa中的aaa不符合
* 匹配 URI 中的通信协议——向前查找（向前匹配到 http 和 ftp 而不包括 : 本身）
  
  `(http[s]|ftp)(?=:)`

# 嵌入条件

正则表达式中有时需要嵌入一定的条件进行匹配。`?( 条件 )` 。

条件可以是一个子表达式，也可以是一个回溯引用的序列数字，即相应的回溯引用子表达式的位置）

如：将一段 html 中的`<img>`标签全部找出来，如果`<img>` 是个链接（即`<img>`位于 `<a></a>` 中），还需要将整个链接标签匹配出来。

```shell
<[aA]\s)+[^>]+>\s*)?<[iI][mM][gG]\s+[^>]+>(?(1)\s*</[aA]>)
```

`(<[aA]\s)+[^>]+>\s*)?`匹配`<a>`或`<A>` 及其任意属性；

`<[iI][mM][gG]\s+[^>]+>` 匹配`<img>` 或 `<IMG>`及其属性；
`(?(1)\s*</[aA]>)` 是回溯引用条件，`?(1)` 指第一个回溯引用（?(1) 中的 1 前面可以
不加 \ 转义），如果`<a>` 或 `<A>` 存在，才利用`\s*</[aA]>` 匹配`</a>` 或`</A>`。

---

**写正则表达式时，把需要匹配的情况和需要排除的情况都考虑周全，考虑需要匹配的情况
比较容易，而考虑周全需要排除的情况往往比较困难。**

---

# POSIX 字符类

正则表达式实现支持的一种方式，支持的如 vim，grep ， python，不支持的如
JavaScript。

| 匹配说明                                  | 字符类         | 等价表达式          |
| ------------------------------------- | ----------- | -------------- |
| 字母或数字                                 | [:alnum:]   | [a-zA-Z0-9]    |
| 字母                                    | [:alpha:]   | [a-zA-Z]       |
| 小写字母                                  | [:lower:]   | [a-z]          |
| 大写字母                                  | [:upper:]   | [A-Z]          |
| 数字                                    | [:digit:]   | [0-9]          |
| 空格或制表符                                | [:blank:]   | [\t ] （t 后有空格） |
| ASCII 控制字符 (ASCII 0 到 31 及 ASCII 127) | [:cntrl:]   |                |
| 同[:print:]                            | `[:graph:]` | [:print:]      |
| 可打印字符                                 | [:print:]   |                |
| 既不属于[:alnum:]也不属于[:cntrl:]的字符         | [:punct:]   |                |
| 空白（包括空格）                              | [:space:]   | [^\f\n\r\t\v]  |
| 十六进制数字                                | [:xdigit:]  | [a-fA-F0-9]    |
